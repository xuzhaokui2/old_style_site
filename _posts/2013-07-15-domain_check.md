---
layout: post
title: 从多级域名中提取主域并验证有效性（未完成）
---

# 起源

需求起源来自于一个用户自定义域名绑定bucket空间的自动化过程。

整个自定义域名绑定bucket空间的流程：

* 客户发起自定义域名(例如img.coaku.com)和bucket空间coaku的绑定操作
* 后台管理系统收到绑定请求，记录需要绑定的域名信息
* 人工从img.coaku.com中提取出主域`coaku.com`和泛二级域`.coaku.com`，提交给CDN进行缓存设置
* CDN缓存设置完成后，回复设置成功的邮件
* 利用alibench.com对缓存设置进行测试，测试全国各地对coaku.com和.coaku.com的可访问性
* 从CDN回复的邮件中获取别名切换的链接，将其通知给客户
* 客户将coaku.com的CNAME指向CDN返回的别名，设置完成


经过以上的设置之后，域名img.coaku.com的解析流程将会变成这样：

* dns query `img.coaku.com`: get CNAME to `coaku.qiniudn.com.`
* dns query `cname.domain.in.cdn`: get CNAME to `coaku.qiniudn.com.`

------------

# 要解决的问题

如何从用户申请的一个域名中扣出主域部分，并保证其有效性(有效性 + 已备案)，相关[知乎提问](http://www.zhihu.com/question/21310402).

ps: 本文中的**主域**指的是通常我们能够注册的那一级的域名，可能是个二级域名，也可能是个三级域名，对于'.com'来说，一个类似'*.coaku.com'这样的二级域名就是主域。而对于'.com.cn'来说，'*.coaku.com.cn'这样的三级域才是主域，因为'com.cn'是不能注册的(是个保留域名，见下文)。

# 思考

## 到底扣出哪一部分

'img.coaku.com'中要扣出'coaku.com','img.coaku.com.cn'中要扣出'coaku.com.cn'

## 扫盲 -> [Wikipedia](http://zh.wikipedia.org/wiki/%E5%9F%9F%E5%90%8D)

### 顶级域名后缀

顶级域名即一级域名，指一个域名中最右边的那个词。

    'img.coaku.com' -> '.com'
    'img.coaku.com.cn' -> '.cn'

顶级域名不能直接注册，所有的域名都是这些顶级域名的下一级注册的。

顶级域名比较好解决，通常分为三类：类别顶级域名、地理顶级域名、新顶级域名。

#### 类别顶级域名

按用途分7个：
.com（用于商业公司）；.net（用于网络服务）；.org（用于组织协会等）；.gov （用于政府部门）； .edu（用于教育机构）；.mil（用于军事领域）；.int（用于国际组织）

原则上类别顶级域名是全球通用的，但出于一些历史原因，'.edu'、'. gov'、'.mil'一般只被美国专用外，另外三类常用的域名'.com'、'.org'、'.net'则成为全世界通用，因此这类域名通常称为“国际域名”，直到现在仍然为世界各国所应用。 

#### 地理类顶级域名

此类域名也称“国内域名”，因为它们通常分别代表一个国家。共有243个国家和地区的代码，例如'.cn'代表中国，'.uk'代表英国等。

和国际域名的分类一样，每个地区会基于自己的地理类顶级域名再往下分类分一级，通常分成两类：类别域名和行政区划域名。 这也是我所说的被保留域名。

类别域名是依照申请机构的性质划分出来的域名，具体包括： 

    ac 科研机构 
    com 工、商、金融等企业 
    edu 教育机构 
    gov 政府部门 
    net 互联网络、接入网络的信息中心(NIC)和运行中心(NOC) 
    org 各种非盈利性的组织 

行政区划域名是按照中国的各个行政区划划分而成。例如北京的为.bj.cn。 

就拿'.cn'来说，以前是不能够直接在'.cn'下注册二级域名的，只能在以上这些被保留的二级域名后面注册相应的三级域名。但是最近

## 新顶级域名

包含7类：biz, info，name，pro，aero, coop, museum。其中前4个是非限制性域，后3个是限制性域，如aero需是航空业公司注册，museum需是博物馆，coop需是集体企业（非投资人控制，无须利润最大化）注册。这7个顶级域名的含义和注册管理机构如下： 


### N级域名

N级域名是按照'.'区分的分级方法。一个域名中有几个点就是几级域名。比如'.com'只有一个'.'，则是一级域名，而'.coaku.com'则是二级域名。

### 保留域名后缀

什么叫做保留？就是我们不能直接注册的，控制权掌握在域名管理者手中的域名。如果利用whois工具查询'com.cn'：

    $ whois com.cn
    the domain you want to register is reserved.

根据观察，被保留的域名通常是个二级域名，由某个地区的域名管理者在当地所属的顶级域名下开辟出来提供注册的一些域名后缀。
一开始以为所谓**顶级域名**就是这些被保留域名的统称，后来发现理解有误，对于**顶级域名**正确的解释即**一级域名**的意思（域名中最后一个词）。

### 泛N级域


## 如何找出顶级域名

按照上面的分析，只要找到了顶级域名或者保留域名后缀，主域就可以确定了，那么问题转化为了从一个多级域名中寻找顶级域和保留域名后缀。

一个直观的思路即将所有的顶级域名和被保留域名后缀都列出来，简单地做后缀匹配就好了。

是这样么?


根据Wikipedia上的介绍，顶级域名五花八门，每个国家也都有自己约定的各种顶级域名。


## 域名知识


## 结论
因为每个国家都有自己的注册规范，因此是没有办法列全所有的域名后缀的。



# 解决办法

示例：找出'a.b.c.d'中的主域

1. 首先列出能够拿到的域名后缀列表，比如从wikipedia上得到。形成一个匹配列表。

2. 按越长越优先匹配列表，如果同时匹配到'.cn'和'.com.cn'，则认为符合'.com.cn'而不是'.cn'

3. 如果只是'.d'匹配到了'.cn'，而没有更长的其他匹配，那么需要进行域名备案查询'c.d'是否合法

